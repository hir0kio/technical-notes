---
description: 相手とリアルタイムに通信することなく秘密の値を共有できる認証付き鍵共有プロトコル。相手がオフラインであっても、相手が事前にサーバに公開した公開鍵を使って秘密の値を共有することができ、非同期的な鍵共有が可能となる。
---

# X3DH 鍵合意プロトコル

X3DH key agreement protocol

相手とリアルタイムに通信することなく秘密の値を共有できる[認証付き鍵共有](https://en.wikipedia.org/wiki/Authenticated_Key_Exchange)プロトコル。相手がオフラインであっても、相手が事前にサーバに公開した公開鍵を使って秘密の値を共有することができ、非同期的な鍵共有が可能となる。

共有後は相手がプロトコルを実行するのに必要な情報をサーバに送信しておき、相手は任意のタイミングでサーバからこの情報を取得して同じ秘密の値を得る。

このプロトコルを使った鍵共有セッションの参加者は[永続鍵](#永続鍵)で互いを認証し、通信の内容について第三者からの否認可能性を有する。また、ある鍵共有セッションで使われた永続鍵が将来危殆化しても、そのセッションで使われた中期・短期鍵が正しく削除されている限り共有した値の機密性は保たれる。

<!--
## 表記法

### ECDH(鍵ペア<sub>0</sub>, 鍵ペア<sub>1</sub>)

[楕円曲線暗号](https://ja.wikipedia.org/wiki/楕円曲線暗号)鍵ペア<sub>0</sub>の秘密鍵と鍵ペア<sub>1</sub>の公開鍵で[楕円曲線ディフィー・ヘルマン鍵共有](https://ja.wikipedia.org/wiki/楕円曲線ディフィー・ヘルマン鍵共有)を行って得られる秘密の値。
-->

## 主な概念

### 永続鍵

identity key

[前鍵バンドル](#前鍵バンドル)に含まれる長期鍵。認証に使う。

### 前鍵

prekey

[前鍵バンドル](#前鍵バンドル)に含まれる中期鍵。定期的に交換する。

### 一時前鍵

ephemeral prekey

[前鍵バンドル](#前鍵バンドル)に含まれる短期鍵。前鍵バンドルのリクエストごとに消費される。最初に複数作成してサーバに登録し、残りが少なくなってきたら補充する。

それぞれの鍵共有セッションに固有のエントロピーを与え、[永続鍵](#永続鍵)と[前鍵](#前鍵)が危殆化しても共有した値の機密性が保たれるようにする。

### 一時鍵

ephemeral key

プロトコルを開始する者がそれぞれの鍵共有セッションごとに作成する短期鍵。

プロトコルが完了すると秘密鍵を削除する。

### 前鍵バンドル

prekey bundle

鍵共有を開始するときにサーバから受け取る、鍵共有の相手のデータ。以下が含まれる。

- 相手の[永続鍵](#永続鍵)の公開鍵
- 相手の[前鍵](#前鍵)の公開鍵
- 前鍵の公開鍵を永続鍵で電子署名したもの
- （相手の[一時前鍵](#一時前鍵)の公開鍵）

## 鍵のライフサイクル

| 鍵       | 種別   | ライフサイクル                                     |
| -------- | ------ | -------------------------------------------------- |
| 永続鍵   | 長期鍵 | 不変。                                             |
| 前鍵     | 中期鍵 | 定期的に交換する。                                 |
| 一時前鍵 | 短期鍵 | 鍵共有ごとに別の鍵を使い、一度使った鍵は削除する。 |
| 一時鍵   | 短期鍵 | 鍵共有ごとに新しく作成し、完了すると削除する。     |

## 役割

- **Alice** は、Bob の[前鍵バンドル](#前鍵バンドル)をサーバから取得し、[X3DH 鍵合意プロトコル](x3dh-key-agreement-protocol)を使って Bob と秘密の値を共有する。ただし、このとき Bob はオフラインである場合がある。
- **Bob** は、事前に前鍵バンドルをサーバに登録して鍵共有を受け付ける。
- **サーバ**は、Alice と Bob が相手に送ったデータを一時的に保持し、相手がオンラインに復帰するとこのデータを配送する。

## 手順

### Bob: 前鍵バンドルの登録

1. Bob は以下の[楕円曲線暗号](https://ja.wikipedia.org/wiki/楕円曲線暗号)鍵を作成する。
   - [永続鍵](#永続鍵)
   - [前鍵](#前鍵)
   - 複数の[一時前鍵](#一時前鍵)
1. 前鍵の公開鍵を永続鍵で電子署名する。
1. 公開鍵と電子署名をサーバに登録する。

前方秘匿性のため、Bob は前鍵を定期的に交換し、古い前鍵を削除する<sup><a href="#ref-1">1</a></sup>。また、一時前鍵は鍵共有ごとに消費されるため、 Bob は一時前鍵の残りが少なくなってきたら新しい一時前鍵を登録する<sup><a href="#ref-2">2</a></sup>。

---

1. <span id="ref-1">ただし、交換する前に送られたメッセージの配送が遅延している場合に備えて、古い前鍵をすぐに削除せずにしばらくの間保持しておくこともできる。</span>
1. <span id="ref-2">なお、一時前鍵が枯渇した場合、プロトコルは続行できるが前方秘匿性の保証は弱まる。詳細は[#鍵の危殆化](#鍵の危殆化)を参照。</span>

### Alice: 鍵共有の開始

1. Alice は以下の楕円曲線暗号鍵を作成する。
   - [永続鍵](#永続鍵)（既存の永続鍵がない場合）
   - [一時鍵](#一時鍵)
1. サーバから以下のデータを含む Bob の[前鍵バンドル](#前鍵バンドル)を取得する。
   - Bob の永続鍵の公開鍵
   - Bob の[前鍵](#前鍵)の公開鍵
   - 前鍵の公開鍵を永続鍵で電子署名したもの
   - （Bob の[一時前鍵](#一時前鍵)の公開鍵）
1. Bob の前鍵の電子署名を検証する。
1. 以下の計算を行って秘密の値 ms を得る。
   - DH1 &larr; ECDH(Alice の永続鍵, Bob の前鍵)
   - DH2 &larr; ECDH(Alice の一時鍵, Bob の永続鍵)
   - DH3 &larr; ECDH(Alice の一時鍵, Bob の前鍵)
   - ms &larr; DH1 + DH2 + DH3
1. Bob の前鍵バンドルに一時前鍵が含まれている場合は、以下の計算を行って秘密の値 ms を得る<sup><a href="#ref-3">3</a></sup>。
   - DH1 &larr; ECDH(Alice の永続鍵, Bob の前鍵)
   - DH2 &larr; ECDH(Alice の一時鍵, Bob の永続鍵)
   - DH3 &larr; ECDH(Alice の一時鍵, Bob の前鍵)
   - DH4 &larr; ECDH(Alice の一時鍵, Bob の一時前鍵)
   - ms &larr; DH1 + DH2 + DH3 + DH4
1. 一時鍵の秘密鍵を削除する。
1. 対称鍵 KDF(ms) を使って、以下のデータを[認証付き暗号](https://ja.wikipedia.org/wiki/認証付き暗号) authenticated encryption with associated data の関連データとして付加したメッセージを Bob に送信する。
   - Alice の永続鍵の公開鍵
   - Alice の一時鍵の公開鍵
   - （もし一時前鍵を使った場合）鍵共有に使った Bob の一時前鍵を識別するもの（_e.g._ ハッシュ値）

---

3. <span id="ref-1">DH1 と DH2 は相互認証を提供し、DH3 と DH4 は前方秘匿性を提供する。つまり、Alice（または Bob）の永続鍵の秘密鍵を持たない第三者は DH1（または DH2）を導出できず、使われた前鍵と一時鍵が削除されたあとは DH3 と DH4 を導出できない。</span>

### Bob: 鍵共有の完了

1. Bob は Alice の[永続鍵](#永続鍵)と[一時鍵](#一時鍵)の公開鍵を含むメッセージを受け取る。
1. 以下の計算を行って秘密の値 ms を得る。
   - DH1 &larr; ECDH(Bob の前鍵, Alice の永続鍵)
   - DH2 &larr; ECDH(Bob の永続鍵, Alice の一時鍵)
   - DH3 &larr; ECDH(Bob の前鍵, Alice の一時鍵)
   - ms &larr; DH1 + DH2 + DH3
1. Alice が使った Bob の[一時前鍵](#一時前鍵)が指定されている場合は、以下の計算を行って秘密の値 ms を得る。
   - DH1 &larr; ECDH(Bob の前鍵, Alice の永続鍵)
   - DH2 &larr; ECDH(Bob の永続鍵, Alice の一時鍵)
   - DH3 &larr; ECDH(Bob の前鍵, Alice の一時鍵)
   - DH4 &larr; ECDH(Bob の一時前鍵, Alice の一時鍵)
   - ms &larr; DH1 + DH2 + DH3 + DH4
1. 指定された一時前鍵を削除する。
1. Alice のメッセージを対称鍵 KDF(ms) で復号する<sup><a href="#ref-4">4</a></sup>。

Bob は Alice と同じ秘密の値 ms を得ることができた。

---

4. <span id="ref-4">復号が失敗した場合、中間者攻撃が起きているか転送中にデータが破損しているため、データを破棄して鍵共有を中止する。</span>

### 鍵共有の完了後

鍵共有を完了したあとは、前方秘匿性や [post-compromise security](post-compromise-security) を保証する [Double Ratchet アルゴリズム](double-ratchet-algorithm)を以降のメッセージの送受信に使う。

## 補足

### 中間者攻撃

鍵共有を仲介するサーバ<sup><a href="#ref-4">4</a></sup>は、攻撃者（_i.e._ Charles）の[永続鍵](#永続鍵)の公開鍵を（a）Alice に Bob の永続鍵として配送し、（b）Bob に Alice の永続鍵として配送することで中間者攻撃を仕掛けることができる。これを防ぐため、Alice と Bob は信頼されている通信チャネルを用いてそれぞれが相手の正しい永続鍵の公開鍵を持っていることを検証する必要がある。

---

4. <span id="ref-4">またはトランスポート層で認証付き暗号が使われていない場合、サーバとの通信を改ざんできる第三者</span>

### 鍵の危殆化

- [永続鍵](#永続鍵)が危殆化した場合、第三者はその鍵の所有者に成りすまして鍵共有を行ったり、所有者が参加する鍵共有セッションに[中間者攻撃](#中間者攻撃)を仕掛けたりすることができる。
- 永続鍵と[前鍵](#前鍵)が危殆化し、
  - 鍵共有セッションで[一時前鍵](#一時前鍵)が**使われている**場合、第三者はそのセッションで共有した値を入手することができない。
  - 鍵共有セッションで一時前鍵が**使われていない**場合、第三者はそのセッションで共有した値を入手することができる。

前鍵を頻繁に交換し、サーバ上の一時前鍵を枯渇させないようにすることで、共有した値が危殆化するリスクを抑えることができる。

### 一時前鍵の枯渇

先に述べたとおり、将来のある時点で[永続鍵](#永続鍵)と[前鍵](#前鍵)が危殆化しても、鍵共有セッションで[一時前鍵](#一時前鍵)が使われておりこれが危殆化していない場合、第三者はそのセッションで共有した値を入手できない。

そこで、悪意のある第三者がサーバに大量に[前鍵バンドル](#前鍵バンドル)を要求し、故意に一時前鍵を枯渇させることで、前方秘匿性のレベルを弱める攻撃が考えられる。

これに対する対策として、前鍵バンドルのリクエストの頻度を制限する、[CAPTCHA](https://ja.wikipedia.org/wiki/CAPTCHA) を要求するなどが考えられる。

## 参考文献

- M. Marlinspike, T. Perrin (2016). "The X3DH key agreement protocol". _Signal Foundation_. https://signal.org/docs/specifications/x3dh/
- K. Cohn-Gordon, C. Cremers, B. Dowling, L. Garratt, D. Stebila (2020). "A formal security analysis of the signal messaging protocol". _Journal of Cryptology_, 33(4), pp. 1914&ndash;1983. https://doi.org/10.1007/s00145-020-09360-1
