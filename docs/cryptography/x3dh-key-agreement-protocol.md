---
description: 相手とリアルタイムにやり取りすることなく鍵共有を完了することができる認証付き鍵共有プロトコル。相手がオフラインであっても、相手がオンラインに復帰するのを待たずに相手が事前にサーバに公開した情報を使って共通鍵を得ることができ、非同期的な鍵共有が可能となる。
---

# X3DH 鍵合意プロトコル

X3DH key agreement protocol

相手とリアルタイムにやり取りすることなく鍵共有を完了することができる[認証付き鍵共有](https://en.wikipedia.org/wiki/Authenticated_Key_Exchange)プロトコル。相手がオフラインであっても、相手がオンラインに復帰するのを待たずに相手が事前にサーバに公開した情報を使って共通鍵を得ることができ、非同期的な鍵共有が可能となる。

共有後は相手がプロトコルを実行するのに必要な情報をサーバに送信しておき、相手は任意のタイミングでサーバからこの情報を取得して同じ共通鍵を得る。

このプロトコルを使った鍵共有セッションの参加者は永続鍵で互いを認証し、通信の内容について第三者からの否認可能性を有する。また、ある鍵共有セッションで使われた永続鍵が将来危殆化しても、そのセッションで使われた短期鍵が正しく抹消されている限り共有した鍵の機密性は保たれる。

## 定義

### ECDH(鍵ペア<sub>0</sub>, 鍵ペア<sub>1</sub>)

鍵ペア<sub>0</sub>の秘密鍵と鍵ペア<sub>1</sub>の公開鍵で[楕円曲線ディフィー・ヘルマン鍵共有](https://ja.wikipedia.org/wiki/楕円曲線ディフィー・ヘルマン鍵共有)を行って得られる秘密の値。

### 文字列<sub>0</sub> \|\| 文字列<sub>1</sub>

文字列<sub>0</sub>と文字列<sub>1</sub>の連結。

### 一時鍵

ephemeral key

イニシエーターが鍵共有セッションごとに作成するユニークな使い捨ての鍵。前方秘匿性のため、イニシエーターは共通鍵が導出できしだい一時鍵の秘密鍵を削除する。

### 一時前鍵

ephemeral prekey

レスポンダーが事前にサーバに公開し、鍵共有ごとに消費される使い捨ての鍵。

### 永続鍵

identity key

鍵共有セッションで本人性を証明するための鍵。

### 前鍵

prekey

前もってサーバに公開しておく鍵。鍵共有後に [Double Ratchet アルゴリズム](/cryptography/double-ratchet-algorithm)で最初の[ルート鍵](/cryptography/double-ratchet-algorithm#ルート-チェーン)として使う。

### 前鍵バンドル

prekey bundle

鍵共有を開始する際にサーバから受け取るデータ。以下のデータが含まれる。

- 永続鍵の公開鍵
- 前鍵の公開鍵
- 前鍵の公開鍵の永続鍵による電子署名
- ［一時前鍵の公開鍵］

## 手順

### 役割

- **Alice**（イニシエーター）は Bob の[前鍵バンドル](#前鍵バンドル)をサーバから取得し、X3DH 鍵合意プロトコルを使って Bob との間に共通鍵を確立する。ただし、これを行うときに Bob はオフラインである場合がある。
- **Bob**（レスポンダー）は事前に自分の前鍵バンドルをサーバに登録する。
- **サーバ**は Alice と Bob の通信を中継する。Alice と Bob が相手に送ったデータを一時的に保持し、対象者がオンラインに復帰するとこのデータを配送する。

### 1. 前鍵バンドルの登録

まず、Bob は以下の[楕円曲線暗号](https://ja.wikipedia.org/wiki/楕円曲線暗号)鍵ペアを作成する。

- 永続鍵
- 前鍵
- 複数の一時前鍵

また、Bob は作成した前鍵の公開鍵を永続鍵で[電子署名](https://ja.wikipedia.org/wiki/楕円曲線DSA)する。

次に、Bob は作成した鍵ペアの公開鍵と電子署名をサーバに登録する。

前方秘匿性のため、Bob はサーバに登録した前鍵を定期的に交換し、古い前鍵を削除すべきである。（ただし、交換する前に送られたメッセージの配送が遅延している場合に備えて、古い前鍵をすぐに削除せずにしばらくの間保管しておくこともできる。）また、一時前鍵は鍵共有ごとに消費されるため、サーバは Bob の一時前鍵の残りが少なくなってきたら Bob にそのことを通知し、Bob に新しい一時前鍵を登録させる必要がある。なお、一時前鍵が枯渇した場合、プロトコルは続行できるが前方秘匿性の保証は弱まる。詳細は[#鍵の危殆化](#鍵の危殆化)を参照。

### 2. メッセージの送信

Bob と共通鍵を確立してデータを送りたい Alice は、以下の楕円曲線暗号鍵ペアを作成する。

- 永続鍵
- 一時鍵

次に、Alice はサーバから Bob の前鍵バンドルを取得する。これには以下のデータが含まれる。

- Bob の永続鍵の公開鍵
- Bob の前鍵の公開鍵
- Bob の前鍵の永続鍵による電子署名
- ［Bob の一時前鍵の公開鍵］

Alice は、Bob の前鍵バンドルに含まれる前鍵の電子署名を検証し、前鍵が第三者によって改ざんされていないことを確認する。

次に、Alice は以下の計算を行う。

DH1 &larr; ECDH(Alice の永続鍵, Bob の前鍵)<br />
DH2 &larr; ECDH(Alice の一時鍵, Bob の永続鍵)<br />
DH3 &larr; ECDH(Alice の一時鍵, Bob の前鍵)<br />
ms &larr; KDF(DH1 || DH2 || DH3)

Bob の前鍵バンドルに一時前鍵が含まれている場合は、以下の計算を行う。

DH4 &larr; ECDH(Alice の一時鍵, Bob の一時前鍵)<br />
ms &larr; KDF(DH1 || DH2 || DH3 || DH4)

DH1 と DH2 は相互認証を提供し、DH3 と DH4 は前方秘匿性を提供する。つまり、Alice（または Bob）の永続鍵の秘密鍵を持たない第三者は DH1（または DH2）を導出できず、使われた前鍵と一時鍵が削除されたあとは DH3 と DH4 を導出できない。

上記の手順で共通鍵 ms が得られたら、前方秘匿性のため Alice は一時鍵の秘密鍵を削除する。

次に、Alice は共通鍵 ms を使って送りたいデータを[認証付き暗号](https://ja.wikipedia.org/wiki/認証付き暗号) authenticated encryption with associated data で暗号化し、以下の情報を関連データとして付加したメッセージを作成して Bob に送信する。

- Alice の永続鍵の公開鍵
- Alice の一時鍵の公開鍵
- ［鍵共有に使った Bob の一時前鍵またはそれを識別できるもの（_e.g._ ハッシュ値）］

### 3. メッセージの受信

Alice のメッセージを受け取った Bob は、以下の計算を行う。

DH1 &larr; ECDH(Bob の前鍵、Alice の永続鍵)<br />
DH2 &larr; ECDH(Bob の永続鍵, Alice の一時鍵)<br />
DH3 &larr; ECDH(Bob の前鍵, Alice の一時鍵)<br />
ms &larr; KDF(DH1 || DH2 || DH3)

Alice のメッセージに Alice が使った Bob の一時前鍵が指定されている場合は、以下の計算を行い、前方秘匿性のためその一時前鍵を削除する。

DH4 &larr; ECDH(Bob の一時前鍵, Alice の一時鍵)<br />
ms &larr; KDF(DH1 || DH2 || DH3 || DH4)

Bob は Alice と同じ共通鍵 ms を得ることができた。Bob は Alice のメッセージを復号し、Alice と同じ共通鍵を得られたことを確認する。

## 鍵の共有後

共通鍵を確立したあとは、この鍵を使って通常の共通鍵暗号方式で通信することもできるが、前方秘匿性や [post-compromise security](/cryptography/post-compromise-security) を保証する [Double Ratchet アルゴリズム](/cryptography/double-ratchet-algorithm)を使うことが推奨される。

## 補足事項

### サーバの信頼

鍵共有を仲介するサーバは、攻撃者（_i.e._ Charles）の永続鍵を（a）Alice に Bob の永続鍵として配送し、（b）Bob に Alice の公開鍵として配送することで中間者攻撃を仕掛けることができる。サーバが信頼されていない場合、これを防ぐため鍵共有を行う前に Alice と Bob は信頼されている通信チャネルを用いてそれぞれが相手の正しい永続鍵を持っていることを検証する必要がある。

### 鍵の危殆化

- 永続鍵が危殆化した場合、第三者はその鍵の所有者に成りすまして鍵共有を行ったり、所有者が参加する鍵共有セッションに中間者攻撃を仕掛けたりすることができる。
- 永続鍵と前鍵が危殆化し、
  - 鍵共有セッションで一時前鍵が**使われている**場合、第三者はそのセッションで共有した共通鍵を復元できない。
  - 鍵共有セッションで一時前鍵が**使われていない**場合、第三者はそのセッションで共有した共通鍵を復元することができる。

前鍵を頻繁に交換し、サーバ上の一時前鍵を枯渇させないようにすることで、共通鍵が危殆化するリスクを抑えることができる。

### 一時前鍵の枯渇

先に述べた通り、将来のある時点で永続鍵と前鍵が危殆化しても、鍵共有セッションで一時前鍵が使われておりこれが危殆化していない場合、第三者はそのセッションで共有した共通鍵を復元できない。

そこで、悪意のある第三者がサーバに大量に前鍵バンドルを要求し、故意に一時前鍵を枯渇させることによって、前方秘匿性のレベルを弱める攻撃が考えられる。

これに対する対策として、前鍵バンドルのリクエストの回数を制限する、[CAPTCHA](https://ja.wikipedia.org/wiki/CAPTCHA) を要求するなどが考えられる。

## 参考文献

- M. Marlinspike, T. Perrin (2016). "The X3DH key agreement protocol". _Signal Foundation_. https://signal.org/docs/specifications/x3dh/
- K. Cohn-Gordon, C. Cremers, B. Dowling, L. Garratt, D. Stebila (2020). "A formal security analysis of the signal messaging protocol". _Journal of Cryptology_, 33(4), pp. 1914&ndash;1983. https://doi.org/10.1007/s00145-020-09360-1
